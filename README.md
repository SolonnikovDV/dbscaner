# Database Object Dependency Graph Scanner

Инструмент для анализа и визуализации графа зависимостей объектов базы данных PostgreSQL. Позволяет исследовать взаимосвязи между таблицами, представлениями, функциями и другими объектами базы данных через веб-интерфейс или GUI приложение.

## Лицензия

Этот проект распространяется под лицензией MIT. Подробности см. в файле [LICENSE](LICENSE).

## Авторские права

Авторские права на этот проект принадлежат **Dmitry Solonnikov** © 2025.

Подробная информация об авторских правах и обязанностях пользователей находится в файле [COPYRIGHT.md](COPYRIGHT.md).

**Кратко:**
- Проект распространяется под лицензией MIT
- Авторские права сохраняются за оригинальным автором
- При использовании обязательно указывать автора
- Подробности см. в [COPYRIGHT.md](COPYRIGHT.md)

## Возможности

- **Два режима работы:**
  - Веб-приложение на Flask для онлайн-анализа
  - Десктопное GUI приложение на PyQt5 для локального использования

- **Анализ объектов БД:**
  - Таблицы (TABLE)
  - Представления (VIEW)
  - Материализованные представления (MATERIALIZED_VIEW)
  - Функции (FUNCTION)
  - Триреры и другие зависимые объекты

- **Рекурсивное построение графа зависимостей:**
  - Восходящие зависимости (объекты, зависящие от текущего)
  - Нисходящие зависимости (объекты, от которых зависит текущий)
  - Интерактивная визуализация с поддержкой глубины анализа

- **Просмотр DDL:**
  - Получение SQL определений объектов через системные каталоги PostgreSQL
  - Отображение структуры таблиц, представлений и функций

- **Тестирование:**
  - Комплект SQL скриптов для создания тестовых объектов
  - Автоматизированные тесты для основных функций

## Установка

### 1. Клонирование репозитория

```bash
git clone <repository-url>
cd dbscaner
```

### 2. Настройка виртуального окружения

Создайте виртуальное окружение для изоляции зависимостей проекта:

```bash
# Создание виртуального окружения
python -m venv venv

# Активация виртуального окружения
# Windows:
venv\Scripts\activate
# Linux/Mac:
source venv/bin/activate
```

После активации в командной строке появится префикс `(venv)`, указывающий на активное виртуальное окружение.

### 3. Установка зависимостей

Установите все необходимые Python пакеты:

```bash
pip install -r requirements.txt
```

### 4. Настройка подключения к базе данных

#### Тестовая среда
Отредактируйте файл `src/config_test.py` для настройки подключения к тестовой базе данных PostgreSQL:

```python
DB_CONFIG = {
    'host': 'localhost',      # Адрес сервера PostgreSQL
    'port': 5432,            # Порт PostgreSQL (по умолчанию 5432)
    'database': 'your_db',   # Имя тестовой базы данных
    'user': 'your_user',     # Имя пользователя PostgreSQL
    'password': 'your_pass'  # Пароль пользователя
}
```

#### Продовая среда
Отредактируйте файл `src/config.py` для настройки подключения к продовой базе данных PostgreSQL:

```python
DB_CONFIG = {
    'host': 'localhost',      # Адрес сервера PostgreSQL
    'port': 5432,            # Порт PostgreSQL (по умолчанию 5432)
    'database': 'your_db',   # Имя продовой базы данных
    'user': 'your_user',     # Имя пользователя PostgreSQL
    'password': 'your_pass'  # Пароль пользователя
}
```

**Примечание:** Убедитесь, что:
- PostgreSQL сервер запущен и доступен
- У пользователя есть права на чтение системных каталогов (`information_schema`, `pg_catalog`)
- База данных содержит анализируемые объекты
- Разделяйте тестовую и продовую среды для безопасности

### 5. Проверка установки

Проверьте корректность установки запустив тесты:

```bash
pytest tests/
```

## Запуск приложения

### Веб-приложение

Запуск веб-приложения для онлайн-анализа через браузер:

```bash
# Вариант 1: Использование скрипта запуска (автоматически добавляет PYTHONPATH)
./run_web.sh

# Вариант 2: Прямой запуск Python модуля (требуется предварительная настройка PYTHONPATH)
export PYTHONPATH="${PYTHONPATH}:$(pwd)"
python src/web/app.py
```

После запуска откройте браузер и перейдите на `http://localhost:5000`

**Интерфейс веб-приложения:**
1. Выберите схему базы данных из выпадающего списка
2. Выберите объект для анализа из списка доступных объектов
3. Изучите интерактивный граф зависимостей
4. Кликните на любой узел графа для просмотра его DDL определения

### Десктопное приложение

Запуск классического GUI приложения:

```bash
python src/main.py
```

**Интерфейс десктопного приложения:**
- **Левая панель**: список всех доступных объектов базы данных
- **Центральная область**: визуализация графа зависимостей
- **Правая панель**: DDL определение выбранного объекта

**Работа с приложением:**
1. Выберите объект из списка слева
2. Граф зависимостей автоматически обновится
3. Кликните на любой узел графа для просмотра его структуры

## Структура проекта

- `src/` - исходный код
  - `config.py` - конфигурация продовой среды (БД, визуализация)
  - `config_test.py` - конфигурация тестовой среды (БД, тестовые объекты)
  - `db_scanner/` - сканеры объектов БД
    - `scanner.py` - устаревший сканер (тестовый)
    - `scanner_new.py` - продовый сканер с рекурсивным анализом
    - `scanner_recursive.py` - альтернативная реализация рекурсивного сканера
    - `scanner_test.py` - переименованный старый сканер для тестов
  - `db/` - подключение к базе данных
  - `graph/` - построение и визуализация графа зависимостей
  - `scanner/` - устаревший модуль сканирования
  - `web/` - Flask веб-приложение
    - REST API для получения данных графа и DDL
    - HTML интерфейс с JavaScript визуализацией
- `tests/` - автоматизированные тесты (pytest) и тестовые данные (SQL скрипты)
- `requirements.txt` - Python зависимости
- `run_web.sh` - скрипт запуска веб-приложения

## Зависимости

- **psycopg2-binary** - подключение к PostgreSQL
- **networkx** - построение и анализ графов
- **matplotlib** - визуализация (для GUI)
- **sqlparse** - парсинг SQL запросов
- **pytest** - тестирование
- **PyQt5** - GUI фреймворк
- **flask** - веб-фреймворк

## Логика работы

### Анализ зависимостей объектов базы данных

Проект использует системные каталоги PostgreSQL для построения графа зависимостей между объектами базы данных. Основная логика реализована в модулях `scanner_new.py` (продакшен) и `scanner_test.py` (тестирование).

#### Типы зависимостей

1. **Нисходящие зависимости (depends_on)** - объекты, от которых зависит текущий объект:
   - Для представлений (VIEW, MATERIALIZED_VIEW): анализ через `pg_rewrite` и `pg_depend`
   - Для функций: парсинг SQL-кода на наличие ссылок на таблицы и представления
   - Для материализованных представлений: анализ определения через `pg_get_viewdef`

2. **Восходящие зависимости (used_by)** - объекты, которые зависят от текущего объекта:
   - Представления, ссылающиеся на текущий объект
   - Функции, использующие текущий объект в своем коде
   - Триггеры, связанные с таблицей
   - Материализованные представления, ссылающиеся на объект

#### Механизмы анализа

- **Системные каталоги**: `pg_class`, `pg_namespace`, `pg_proc`, `pg_rewrite`, `pg_depend`
- **Парсинг SQL**: регулярные выражения для поиска ссылок на объекты в определениях функций и представлений
- **Рекурсивный обход**: построение полного дерева зависимостей с ограничением глубины (max_depth=10)
- **Дедупликация**: устранение дублированных связей и самореференций

### Построение и визуализация графа

1. **Сбор данных**: рекурсивное получение всех связанных объектов от центрального узла
2. **Создание графа**: использование NetworkX для построения направленного графа
3. **Визуализация**: интерактивная веб-визуализация с поддержкой:
   - Выделения центрального объекта
   - Отображения типов связей (depends_on, used_by)
   - Уровней глубины анализа
   - Клик по узлам для просмотра DDL

### Получение DDL определений

- **Представления**: `pg_get_viewdef()` для обычных и материализованных представлений
- **Функции**: `pg_get_functiondef()` для получения полного определения функции
- **Таблицы**: формирование CREATE TABLE на основе структуры из `pg_attribute`
- **Обработка ошибок**: возврат информативных сообщений при невозможности получить определение

### Архитектура приложения

#### Веб-приложение (Flask)
- **REST API**:
  - `/schemas` - получение списка схем
  - `/objects/<schema>` - получение объектов в схеме
  - `/graph/<schema>/<object>` - получение данных графа зависимостей
  - `/ddl/<schema>/<object>` - получение DDL объекта
- **Шаблоны**: HTML с JavaScript для интерактивной визуализации
- **AJAX**: динамическая загрузка данных без перезагрузки страницы

#### Десктопное приложение (PyQt5)
- **Графический интерфейс**: список объектов слева, область графа и DDL справа
- **PyQtGraph/Matplotlib**: визуализация графа с интерактивностью
- **Синхронная работа**: прямой вызов методов сканера без промежуточного API

## Тестирование

### Запуск тестов

Запустите тесты командой: `pytest tests/`

### Создание тестовых данных

Создайте тестовые объекты в БД: `psql -d your_db -f sql/test_objects/extended_test_objects.sql`

**Примечание:** Тестовые SQL скрипты находятся в директории `sql/test_objects/` и используются для инициализации тестовой схемы `test_graph`.